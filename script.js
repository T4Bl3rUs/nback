const screenTransitionDuration=100,mainMenu=document.getElementById("mainMenu"),gameModes=document.getElementById("gameModes"),settingsScreen=document.getElementById("settingsScreen"),gameScreen=document.getElementById("gameScreen"),screenTimeouts={};let figuresList=[];const gridSizeSlider=document.getElementById("gridSizeSlider"),innerGridSizeSlider=document.getElementById("innerGridSizeSlider"),nBackSlider=document.getElementById("nBackSlider"),timeIntervalSlider=document.getElementById("timeIntervalSlider"),compareModeButtons=document.getElementById("compareModeButtons"),drawModeButtons=document.getElementById("drawModeButtons"),reverseModeButtons=document.getElementById("reverseModeButtons"),selectModeButtons=document.getElementById("selectModeButtons"),btnCompareShape=compareModeButtons.querySelector("#btnCompareShape"),btnComparePosition=compareModeButtons.querySelector("#btnComparePosition"),btnCompareColor=compareModeButtons.querySelector("#btnCompareColor"),btnDrawReset=drawModeButtons.querySelector("#btnDrawReset"),btnDrawSubmit=drawModeButtons.querySelector("#btnDrawSubmit"),sliderReverseNBack=reverseModeButtons.querySelector("#sliderReverseNBack"),sliderReverseNBackValue=reverseModeButtons.querySelector("#sliderReverseNBackValue"),btnReverseSubmit=reverseModeButtons.querySelector("#btnReverseSubmit"),btnSelectSubmit=selectModeButtons.querySelector("#btnSelectSubmit"),gameGrid=document.getElementById("gameGrid");let previousScreen=null,lastFiguresDisplayed=[];function saveSettingsToLocalStorage(){let e={gridSize:gridSizeSlider.value,innerGridSize:innerGridSizeSlider.value,nBack:nBackSlider.value,timeInterval:timeIntervalSlider.value};localStorage.setItem("nBackSettings",JSON.stringify(e))}function loadSettingsFromLocalStorage(){let e=localStorage.getItem("nBackSettings");if(e){let t=JSON.parse(e);gridSizeSlider.value=t.gridSize,document.getElementById("gridSizeValue").value=t.gridSize,innerGridSizeSlider.value=t.innerGridSize,document.getElementById("innerGridSizeValue").value=t.innerGridSize,nBackSlider.value=t.nBack,document.getElementById("nBackValue").value=t.nBack,timeIntervalSlider.value=t.timeInterval,document.getElementById("timeIntervalValue").value=t.timeInterval}}function generateEmptyGrid(e){let t=[];for(let s=0;s<e;s++){let r=[];for(let i=0;i<e;i++)r.push(!1);t.push(r)}return t}function isAdjacentCellEnabled(e,t,s,r,i){let a=t+r,l=s+i;return!(a<0)&&!(l<0)&&!(a>=e.shape.length)&&!(l>=e.shape.length)&&e.shape[a][l]}function displayGameGrid(e=[]){let t=parseInt(gridSizeSlider.value);gameGrid.innerHTML="",lastFiguresDisplayed=e;for(let s=0;s<t;s++){let r=document.createElement("div");r.className="gridRow";for(let i=0;i<t;i++){let a=document.createElement("div");a.className="gridCell",a.dataset.x=i,a.dataset.y=s,a.addEventListener("click",function(){"select"===game.gameMode&&game.correctSelectAnswers&&game.correctSelectAnswers.length>0&&this.classList.toggle("selected")}),r.appendChild(a)}gameGrid.appendChild(r)}gameGrid.style.width=`${gameGrid.clientHeight}px`,e.length>0&&e.forEach(e=>{let t=document.createElement("div");t.className="figureContainer",gameGrid.children[e.y].children[e.x].appendChild(t);let s=e.shape.length;for(let r=0;r<s;r++){let i=document.createElement("div");i.className="figureContainerRow",t.appendChild(i);for(let a=0;a<s;a++){let l=document.createElement("div");l.className="innerGridCell",i.appendChild(l);let n=t.offsetWidth/s,o=Math.max(Math.min(Math.floor(n/10),6),1);l.style.borderWidth=o+"px";let d=4*o;o>=4&&(d+=4),l.style.borderRadius=d+"px",e.shape[r][a]&&(l.style.backgroundColor=e.color,l.style.borderImageSource=`url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg version="1.1" width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1 h1 v1 h-1 z M4 1 h1 v1 h-1 z M2 2 h1 v1 h-1 z M5 2 h1 v1 h-1 z M1 3 h1 v1 h-1 z M6 3 h1 v1 h-1 z M1 4 h1 v1 h-1 z M6 4 h1 v1 h-1 z M2 5 h1 v1 h-1 z M5 5 h1 v1 h-1 z M3 6 h1 v1 h-1 z M4 6 h1 v1 h-1 z" fill="${e.color}" /></svg>')`,isAdjacentCellEnabled(e,r,a,-1,0)&&(l.style.borderTopLeftRadius=0,l.style.borderTopRightRadius=0),isAdjacentCellEnabled(e,r,a,1,0)&&(l.style.borderBottomLeftRadius=0,l.style.borderBottomRightRadius=0),isAdjacentCellEnabled(e,r,a,0,-1)&&(l.style.borderTopLeftRadius=0,l.style.borderBottomLeftRadius=0),isAdjacentCellEnabled(e,r,a,0,1)&&(l.style.borderTopRightRadius=0,l.style.borderBottomRightRadius=0))}}})}class ShapeSystem{constructor(){let e=[];for(let t=0;t<360;t+=60)e.push(`hsl(${t}, 75%, 75%)`);this.config={colors:e}}generateRandomShape(e=[]){let t,s,r=parseInt(innerGridSizeSlider.value);do{s=this.getRandomColor(),t=[];for(let i=0;i<r;i++){let a=[];for(let l=0;l<r;l++)a.push(Math.random()>=.5);t.push(a)}}while(this.isInExcludeList(t,s,e)||this.isAllFalse(t));return{shape:t,color:s}}isInExcludeList(e,t,s){for(let r=0;r<s.length;r++)if(t===s[r].color&&this.isEqual(e,s[r].shape))return!0;return!1}isEqual(e,t){let s=parseInt(innerGridSizeSlider.value);for(let r=0;r<s;r++)for(let i=0;i<s;i++)if(e[r][i]!==t[r][i])return!1;return!0}isAllFalse(e){let t=parseInt(innerGridSizeSlider.value);for(let s=0;s<t;s++)for(let r=0;r<t;r++)if(e[s][r])return!1;return!0}getRandomColor(){let e=Math.floor(Math.random()*this.config.colors.length);return this.config.colors[e]}}const shapeSystem=new ShapeSystem;class Game{constructor(){this.gameState="stopped",this.gameMode=null,this.streak=0,this.pausedInterval=0,this.gameInterval=null,this.highScores={},this.currentHighScore=0;let e=localStorage.getItem("nBackHighScores");e&&(this.highScores=JSON.parse(e))}start(){let e=this.gameMode,t=nBackSlider.value,s=gridSizeSlider.value,r=innerGridSizeSlider.value,i=timeIntervalSlider.value;this.currentHighScore=this.getHighScore(e,t,s,r,i),figuresList=[],document.getElementById("highScore").innerText=this.currentHighScore,document.getElementById("scores").style.display="flex",document.getElementById("pauseOverlay").style.display="none",document.getElementById("startPrompt").style.display="none",document.getElementById("backdrop").style.display="none","stopped"===this.gameState&&(this.gameState="running",this.gameLoop()),console.log("> Start")}gameLoop(){let e=1e3*parseFloat(timeIntervalSlider.value);if("running"===this.gameState&&this.gameMode){if("compare"===this.gameMode){let t=parseInt(gridSizeSlider.value),s={x:Math.floor(Math.random()*t),y:Math.floor(Math.random()*t),...shapeSystem.generateRandomShape()};if(figuresList.length>parseInt(nBackSlider.value)){let r=btnCompareShape.classList.contains("is-success"),i=btnComparePosition.classList.contains("is-success"),a=btnCompareColor.classList.contains("is-success"),l=figuresList.shift(),n=shapeSystem.isEqual(l.shape,figuresList[figuresList.length-1].shape),o=l.x===figuresList[figuresList.length-1].x&&l.y===figuresList[figuresList.length-1].y,d=l.color===figuresList[figuresList.length-1].color;n===r&&o===i&&d===a?(this.streak++,document.getElementById("currentScore").innerText=this.streak,console.log("Correct",this.streak)):(this.breakStreak(),console.log("Incorrect:",n,r,o,i,d,a))}else figuresList.length===parseInt(nBackSlider.value)&&Array.from(compareModeButtons.children).forEach(e=>{e.classList.add("is-error"),e.classList.remove("is-disabled")});Array.from(compareModeButtons.children).forEach(e=>{e.classList.contains("is-success")&&(e.classList.remove("is-success"),e.classList.add("is-error"))}),figuresList.push(s),displayGameGrid([s])}else if("reverse"===this.gameMode){document.documentElement.style.setProperty("--grid-border-color","white"),document.documentElement.style.setProperty("--grid-border-width","2px"),btnReverseSubmit.classList.remove("is-primary"),btnReverseSubmit.classList.add("is-disabled"),sliderReverseNBack.disabled=!0,sliderReverseNBackValue.disabled=!0,sliderReverseNBack.value=1,sliderReverseNBackValue.value=1,this.resetButtons&&(btnReverseSubmit.classList.remove("is-success"),btnReverseSubmit.classList.remove("is-error"));let c=parseInt(gridSizeSlider.value),m=Math.floor(Math.random()*c),g=Math.floor(Math.random()*c);if(!this.resetButtons||figuresList.length<parseInt(nBackSlider.value)||Math.random()>.25){let u={x:m,y:g,...shapeSystem.generateRandomShape(figuresList)};figuresList.push(u),displayGameGrid([u]),figuresList.length>parseInt(nBackSlider.value)&&figuresList.shift(),this.resetButtons=!0}else{let h=Math.floor(Math.random()*figuresList.length),S=figuresList[h];displayGameGrid([{x:m,y:g,shape:S.shape,color:S.color}]),this.correctReverseAnswer=figuresList.length-h,sliderReverseNBack.disabled=!1,sliderReverseNBackValue.disabled=!1,btnReverseSubmit.classList.remove("is-disabled"),btnReverseSubmit.classList.add("is-primary"),document.documentElement.style.setProperty("--grid-border-color","goldenrod"),document.documentElement.style.setProperty("--grid-border-width","3px");return}}else if("select"===this.gameMode){document.documentElement.style.setProperty("--grid-border-color","white"),document.documentElement.style.setProperty("--grid-border-width","2px"),btnSelectSubmit.classList.remove("is-primary"),btnSelectSubmit.classList.add("is-disabled"),this.resetButtons&&(btnSelectSubmit.classList.remove("is-success"),btnSelectSubmit.classList.remove("is-error"));let p=parseInt(gridSizeSlider.value);if(!this.resetButtons||figuresList.length<parseInt(nBackSlider.value)||Math.random()>.25){let v={x:Math.floor(Math.random()*p),y:Math.floor(Math.random()*p),...shapeSystem.generateRandomShape(figuresList)};figuresList.push(v),displayGameGrid([v]),figuresList.length>parseInt(nBackSlider.value)&&figuresList.shift(),this.resetButtons=!0}else{let y=figuresList[0];this.correctSelectAnswers=[];let f=[];for(let b=0;b<p;b++)for(let B=0;B<p;B++){let L={x:b,y:B,...shapeSystem.generateRandomShape()};f.push(L),(L.x===y.x&&L.y===y.y||L.color===y.color||shapeSystem.isEqual(L.shape,y.shape))&&this.correctSelectAnswers.push({i:b,j:B})}displayGameGrid(f),btnSelectSubmit.classList.remove("is-disabled"),btnSelectSubmit.classList.add("is-primary"),document.documentElement.style.setProperty("--grid-border-color","goldenrod"),document.documentElement.style.setProperty("--grid-border-width","3px");return}}this.pausedInterval=new Date().getTime(),this.gameInterval=setTimeout(()=>this.gameLoop(),e)}}pause(e=""){if("running"===this.gameState&&this.gameState!=e)this.gameState="paused",document.getElementById("pauseOverlay").style.display="flex",document.getElementById("backdrop").style.display="block",this.pausedInterval=this.pausedInterval+1e3*parseFloat(timeIntervalSlider.value)-new Date().getTime(),clearTimeout(this.gameInterval),console.log("> Pause");else if("paused"===this.gameState&&this.gameState!=e){if(this.gameState="running",document.getElementById("pauseOverlay").style.display="none",document.getElementById("backdrop").style.display="none",console.log("> Resume"),this.correctReverseAnswer>0&&"reverse"===this.gameMode)return;this.gameInterval=setTimeout(()=>this.gameLoop(),this.pausedInterval),this.pausedInterval=new Date().getTime()-1e3*parseFloat(timeIntervalSlider.value)+this.pausedInterval}}stop(){this.gameState="stopped",clearTimeout(this.gameInterval),this.breakStreak(),this.gameMode=null,console.log("> Stop"),document.getElementById("startPrompt").style.display="none",document.getElementById("pauseOverlay").style.display="none",document.getElementById("backdrop").style.display="none"}getHighScore(e,t,s,r,i){return this.highScores[e]&&this.highScores[e][t]&&this.highScores[e][t][s]&&this.highScores[e][t][s][r]&&this.highScores[e][t][s][r][i]||0}breakStreak(){if(this.streak>0){let e=this.gameMode,t=nBackSlider.value,s=gridSizeSlider.value,r=innerGridSizeSlider.value,i=timeIntervalSlider.value;this.highScores[e]=this.highScores[e]||{},this.highScores[e][t]=this.highScores[e][t]||{},this.highScores[e][t][s]=this.highScores[e][t][s]||{},this.highScores[e][t][s][r]=this.highScores[e][t][s][r]||{},this.streak>this.getHighScore(e,t,s,r,i)&&(this.highScores[e][t][s][r][i]=this.streak,this.currentHighScore=this.streak,document.getElementById("highScore").innerText=this.currentHighScore,localStorage.setItem("nBackHighScores",JSON.stringify(this.highScores))),this.streak=0,document.getElementById("currentScore").innerText=this.streak}}}const game=new Game;function showGameModes(){screenTimeouts.gameModes&&clearTimeout(screenTimeouts.gameModes),mainMenu.classList.remove("active"),screenTimeouts.mainMenu=setTimeout(()=>{mainMenu.style.display="none"},100),gameScreen.classList.remove("active"),screenTimeouts.gameScreen=setTimeout(()=>{gameScreen.style.display="none"},100),gameModes.style.display="",gameModes.classList.add("active"),game.stop(),document.getElementById("scores").style.display="none",document.getElementById("startPrompt").style.display="none",document.getElementById("backdrop").style.display="none",previousScreen="mainMenu"}function startGame(e=""){screenTimeouts.gameScreen&&clearTimeout(screenTimeouts.gameScreen),gameModes.classList.remove("active"),screenTimeouts.gameModes=setTimeout(()=>{gameModes.style.display="none"},100),gameScreen.style.display="",gameScreen.classList.add("active");let t=parseInt(gridSizeSlider.value);figuresList=[],compareModeButtons.style.display="compare"===e?"":"none",drawModeButtons.style.display="draw"===e?"":"none",reverseModeButtons.style.display="reverse"===e?"flex":"none",selectModeButtons.style.display="select"===e?"":"none",document.getElementById("startPrompt").style.display="flex",document.getElementById("backdrop").style.display="block",gameGrid.style.width="",displayGameGrid(t),document.documentElement.style.setProperty("--grid-border-color","white"),document.documentElement.style.setProperty("--grid-border-width","2px"),previousScreen="gameModes"}function startCompareMode(){Array.from(compareModeButtons.children).forEach(e=>{e.classList.remove("is-success"),e.classList.remove("is-error"),e.classList.add("is-disabled")}),startGame("compare"),game.gameMode="compare"}function startDrawMode(){Array.from(drawModeButtons.children).forEach(e=>{e.classList.remove("is-success"),e.classList.remove("is-error"),e.classList.add("is-disabled")}),startGame("draw"),game.gameMode="draw"}function startReverseMode(){Array.from(reverseModeButtons.children).forEach(e=>{e.classList.remove("is-success"),e.classList.remove("is-error"),e.classList.add("is-disabled")}),document.getElementById("sliderReverseNBack").max=parseInt(nBackSlider.value),document.getElementById("sliderReverseNBackValue").max=parseInt(nBackSlider.value),startGame("reverse"),game.correctReverseAnswer=0,game.gameMode="reverse"}function startSelectAllMode(){Array.from(selectModeButtons.children).forEach(e=>{e.classList.remove("is-success"),e.classList.remove("is-error"),e.classList.add("is-disabled")}),startGame("select"),game.gameMode="select"}function showSettings(){screenTimeouts.settingsScreen&&clearTimeout(screenTimeouts.settingsScreen),screenTimeouts.mainMenu=setTimeout(()=>{mainMenu.style.display="none"},100),mainMenu.classList.remove("active"),settingsScreen.style.display="",settingsScreen.classList.add("active"),previousScreen="mainMenu"}function toggleShape(){btnCompareShape.classList.contains("is-disabled")||(btnCompareShape.classList.toggle("is-error"),btnCompareShape.classList.toggle("is-success"))}function togglePosition(){btnComparePosition.classList.contains("is-disabled")||(btnComparePosition.classList.toggle("is-error"),btnComparePosition.classList.toggle("is-success"))}function toggleColor(){btnCompareColor.classList.contains("is-disabled")||(btnCompareColor.classList.toggle("is-error"),btnCompareColor.classList.toggle("is-success"))}function reverseSubmit(){if(game.correctReverseAnswer<1)return;let e=parseInt(document.getElementById("sliderReverseNBackValue").value);btnReverseSubmit.classList.remove("is-primary"),btnReverseSubmit.classList.add("is-disabled"),game.resetButtons=!1,e===game.correctReverseAnswer?(btnReverseSubmit.classList.remove("is-error"),btnReverseSubmit.classList.add("is-success"),game.streak++,console.log("Correct",game.streak)):(btnReverseSubmit.classList.remove("is-success"),btnReverseSubmit.classList.add("is-error"),game.breakStreak(),console.log("Incorrect:",e,game.correctReverseAnswer)),game.correctReverseAnswer=0,document.getElementById("currentScore").innerText=game.streak,game.gameLoop()}function selectSubmit(){let e=document.querySelectorAll(".gridCell.selected"),t=0,s=[];game.resetButtons=!1,e.forEach(e=>{let r=parseInt(e.dataset.x),i=parseInt(e.dataset.y);s.push({i:r,j:i});let a=game.correctSelectAnswers.some(e=>e.i===r&&e.j===i);a&&t++}),t===game.correctSelectAnswers.length&&t===e.length?(btnSelectSubmit.classList.remove("is-error"),btnSelectSubmit.classList.add("is-success"),game.streak++,console.log("Correct",game.streak)):(btnSelectSubmit.classList.remove("is-success"),btnSelectSubmit.classList.add("is-error"),game.breakStreak(),console.log("Incorrect:",s,game.correctSelectAnswers)),game.correctSelectAnswers=[],document.getElementById("currentScore").innerText=game.streak,game.gameLoop()}function exitGame(){document.getElementById("exit-game-dialog").showModal(),game.pause("paused")}function goBack(){previousScreen&&("mainMenu"===previousScreen?(screenTimeouts.mainMenu&&clearTimeout(screenTimeouts.mainMenu),gameModes.classList.remove("active"),screenTimeouts.gameModes=setTimeout(()=>{gameModes.style.display="none"},100),settingsScreen.classList.remove("active"),screenTimeouts.settingsScreen=setTimeout(()=>{settingsScreen.style.display="none"},100),mainMenu.style.display="",mainMenu.classList.add("active")):"gameModes"===previousScreen&&game.pause())}document.addEventListener("keydown",function(e){"Escape"===e.key?"gameModes"!==previousScreen?goBack():game.pause():"s"===e.key?toggleShape():"p"===e.key?togglePosition():"c"===e.key&&toggleColor()}),document.addEventListener("DOMContentLoaded",function(){loadSettingsFromLocalStorage();document.querySelectorAll('input[type="range"]').forEach(e=>{e.addEventListener("input",function(){let e=this.parentNode.querySelector(".sliderValue");e&&(e.value=this.value),saveSettingsToLocalStorage()})});document.querySelectorAll(".sliderValue").forEach(e=>{e.addEventListener("input",function(){if(this.value){let e=parseInt(this.min),t=parseInt(this.max),s=parseInt(this.value);s>t?this.value=t:s<e&&(this.value=e);this.parentNode.querySelector('input[type="range"]').value=this.value}saveSettingsToLocalStorage()}),e.addEventListener("blur",function(){if(!this.value||parseFloat(this.value)!==parseInt(this.value)){let e=this.parentNode.querySelector('input[type="range"]');this.value=e.value}saveSettingsToLocalStorage()})});let e=document.querySelectorAll(".gameModeBtn"),t=document.querySelectorAll(".modeDescription .nes-text");e.forEach(e=>{e.addEventListener("mouseenter",function(){let e=this.getAttribute("data-mode");t.forEach(t=>{t.classList.contains(e)?t.style.display="":t.style.display="none"})})})}),window.addEventListener("resize",function(){"gameModes"===previousScreen&&(gameGrid.style.width=`${gameGrid.clientHeight-6}px`,displayGameGrid(lastFiguresDisplayed))});
